"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.AST=exports.ASTNode=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_token=require("./token"),_expression=require("./expression"),_yielder=require("./yielder"),ASTNode=function(){function a(b,c){(0,_classCallCheck2.default)(this,a),this.type=c,this.tokens=b,this.childNodeList=[]}return(0,_createClass2.default)(a,[{key:"addChild",value:function addChild(a){this.childNodeList.push(a)}}]),a}();exports.ASTNode=ASTNode;var AST=function(){function a(b){(0,_classCallCheck2.default)(this,a),this.tokens=b}return(0,_createClass2.default)(a,[{key:"buildTree",value:_regenerator.default.mark(function buildTree(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.delegateYield(this.handleExprJson(this.tokens),"t0",1);case 1:return a.abrupt("return",a.t0);case 2:case"end":return a.stop();}},buildTree,this)})},{key:"handleExprJson",value:_regenerator.default.mark(function handleExprJson(a){var b,c,d,e;return _regenerator.default.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:if(!(0,_yielder.yielder)()){f.next=3;break}return void(f.next=3);case 3:if(b=new ASTNode(a,_expression.ExprType.Json),c=a[0],c.type!==_token.TokenType.LeftBracket){f.next=11;break}return f.delegateYield(this.handleExprArray(a),"t0",7);case 7:d=f.t0,b.addChild(d),f.next=18;break;case 11:if(c.type!==_token.TokenType.LeftBrace){f.next=17;break}return f.delegateYield(this.handleExprObject(a),"t1",13);case 13:e=f.t1,b.addChild(e),f.next=18;break;case 17:throw new Error("[json expression error] unexpected token ".concat(c.text));case 18:return f.abrupt("return",b);case 19:case"end":return f.stop();}},handleExprJson,this)})},{key:"handleExprArray",value:_regenerator.default.mark(function handleExprArray(a){var b,c,d,e,f,g,h,i,j;return _regenerator.default.wrap(function(k){for(;;)switch(k.prev=k.next){case 0:if(2!==a.length||a[0].type!==_token.TokenType.LeftBracket||a[1].type!==_token.TokenType.RightBracket){k.next=2;break}return k.abrupt("return",new ASTNode(a,_expression.ExprType.Array));case 2:b=new ASTNode(a,_expression.ExprType.Array),c=[],d=0,e=0,f=1,g=a.length-1;case 7:if(!(f<g)){k.next=40;break}if(!(0,_yielder.yielder)()){k.next=11;break}return void(k.next=11);case 11:if(h=a[f],h.type!==_token.TokenType.Comma||0!==d||0!==e){k.next=24;break}if(1!==c.length){k.next=17;break}k.t0=this.handleExprValueDirect(c),k.next=19;break;case 17:return k.delegateYield(this.handleExprValue(c),"t1",18);case 18:k.t0=k.t1;case 19:i=k.t0,c=[],b.addChild(i),k.next=37;break;case 24:k.t2=h.type,k.next=k.t2===_token.TokenType.RightBrace?27:k.t2===_token.TokenType.RightBracket?29:k.t2===_token.TokenType.LeftBrace?31:k.t2===_token.TokenType.LeftBracket?33:35;break;case 27:return d--,k.abrupt("break",36);case 29:return e--,k.abrupt("break",36);case 31:return d++,k.abrupt("break",36);case 33:return e++,k.abrupt("break",36);case 35:return k.abrupt("break",36);case 36:c.push(h);case 37:f++,k.next=7;break;case 40:if(1!==c.length){k.next=44;break}k.t3=this.handleExprValueDirect(c),k.next=46;break;case 44:return k.delegateYield(this.handleExprValue(c),"t4",45);case 45:k.t3=k.t4;case 46:return j=k.t3,b.addChild(j),k.abrupt("return",b);case 49:case"end":return k.stop();}},handleExprArray,this)})},{key:"handleExprObject",value:_regenerator.default.mark(function handleExprObject(a){var b,c,d,e,f,g,h,i,j,k,l,m;return _regenerator.default.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(2!==a.length||a[0].type!==_token.TokenType.LeftBrace||a[1].type!==_token.TokenType.RightBrace){n.next=2;break}return n.abrupt("return",new ASTNode(a,_expression.ExprType.Object));case 2:b=new ASTNode(a,_expression.ExprType.Object),d=[],e=[],f=0,g=0,h="prop",i=1,j=a.length-1;case 9:if(!(i<j)){n.next=58;break}if(!(0,_yielder.yielder)()){n.next=13;break}return void(n.next=13);case 13:if(k=a[i],k.type!==_token.TokenType.Colon||"prop"!==h){n.next=21;break}return n.delegateYield(this.handleExprProp(d),"t0",16);case 16:c=n.t0,d=[],h="value",n.next=55;break;case 21:if(k.type!==_token.TokenType.Comma||"prop"!==h||0!==f||0!==g){n.next=34;break}if(1!==e.length){n.next=26;break}n.t1=this.handleExprValueDirect(e),n.next=28;break;case 26:return n.delegateYield(this.handleExprValue(e),"t2",27);case 27:n.t1=n.t2;case 28:l=n.t1,e=[],c.addChild(l),b.addChild(c),n.next=55;break;case 34:n.t3=h,n.next="prop"===n.t3?37:"value"===n.t3?39:54;break;case 37:return d.push(k),n.abrupt("break",55);case 39:n.t4=k.type,n.next=n.t4===_token.TokenType.RightBrace?42:n.t4===_token.TokenType.RightBracket?44:n.t4===_token.TokenType.LeftBrace?46:n.t4===_token.TokenType.LeftBracket?48:50;break;case 42:return f--,n.abrupt("break",51);case 44:return g--,n.abrupt("break",51);case 46:return f++,n.abrupt("break",51);case 48:return g++,n.abrupt("break",51);case 50:return n.abrupt("break",51);case 51:return e.push(k),0===f&&0===g&&(h="prop"),n.abrupt("break",55);case 54:throw new Error("[object expression error] unexpected state");case 55:i++,n.next=9;break;case 58:if(1!==e.length){n.next=62;break}n.t5=this.handleExprValueDirect(e),n.next=64;break;case 62:return n.delegateYield(this.handleExprValue(e),"t6",63);case 63:n.t5=n.t6;case 64:return m=n.t5,c.addChild(m),b.addChild(c),n.abrupt("return",b);case 68:case"end":return n.stop();}},handleExprObject,this)})},{key:"handleExprProp",value:_regenerator.default.mark(function handleExprProp(a){var b;return _regenerator.default.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!(0,_yielder.yielder)()){c.next=3;break}return void(c.next=3);case 3:return b=new ASTNode(a,_expression.ExprType.Prop),b.propName=a[0].text.slice(1,-1),c.abrupt("return",b);case 6:case"end":return c.stop();}},handleExprProp)})},{key:"handleExprValueDirect",value:function handleExprValueDirect(a){var b=new ASTNode(a,_expression.ExprType.Value),c=a[0].type;switch(c){case _token.TokenType.Null:case _token.TokenType.Boolean:case _token.TokenType.Number:case _token.TokenType.String:b.value=new ASTNode(a,c);break;default:throw new Error("[value expression error] unknown single token type");}return b}},{key:"handleExprValue",value:_regenerator.default.mark(function handleExprValue(a){var b;return _regenerator.default.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:if(!(0,_yielder.yielder)()){c.next=3;break}return void(c.next=3);case 3:return b=new ASTNode(a,_expression.ExprType.Value),c.delegateYield(this.handleExprJson(a),"t0",5);case 5:return b.value=c.t0,c.abrupt("return",b);case 7:case"end":return c.stop();}},handleExprValue,this)})}]),a}();exports.AST=AST;