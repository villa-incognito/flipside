"use strict";var _regeneratorRuntime2=require("@babel/runtime/regenerator"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.parse=parse,exports.ASTParser=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_tokenizer=require("./tokenizer"),_ast=require("./ast"),_expression=require("./expression"),_token=require("./token"),_yielder=require("./yielder"),_marked=_regeneratorRuntime2.mark(parse);function _createForOfIteratorHelper(o,a){var b;if("undefined"==typeof Symbol||null==o[Symbol.iterator]){if(Array.isArray(o)||(b=_unsupportedIterableToArray(o))||a&&o&&"number"==typeof o.length){b&&(o=b);var c=0,d=function(){};return{s:d,n:function n(){return c>=o.length?{done:!0}:{done:!1,value:o[c++]}},e:function e(a){throw a},f:d}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var e,f=!0,g=!1;return{s:function s(){b=o[Symbol.iterator]()},n:function n(){var a=b.next();return f=a.done,a},e:function e(a){g=!0,e=a},f:function f(){try{f||null==b.return||b.return()}finally{if(g)throw e}}}}function _unsupportedIterableToArray(o,a){if(o){if("string"==typeof o)return _arrayLikeToArray(o,a);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,a):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var ASTParser=function(){function a(b){(0,_classCallCheck2.default)(this,a),this.ast=b}return(0,_createClass2.default)(a,[{key:"getJson",value:_regenerator.default.mark(function getJson(){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.delegateYield(this.handleValue(this.ast),"t0",1);case 1:return a.abrupt("return",a.t0);case 2:case"end":return a.stop();}},getJson,this)})},{key:"handleJson",value:_regenerator.default.mark(function handleJson(a){var b,c,d,e,f,g,h,i;return _regenerator.default.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(a.type===_expression.ExprType.Json){j.next=2;break}throw new Error("[parse AST error] unexpected node type, expect Json");case 2:if(c=a.childNodeList[0],c.type!==_expression.ExprType.Array){j.next=26;break}b=[],d=_createForOfIteratorHelper(c.childNodeList),j.prev=6,d.s();case 8:if((e=d.n()).done){j.next=16;break}return f=e.value,j.t0=b,j.delegateYield(this.handleValue(f.value),"t1",12);case 12:j.t2=j.t1,j.t0.push.call(j.t0,j.t2);case 14:j.next=8;break;case 16:j.next=21;break;case 18:j.prev=18,j.t3=j["catch"](6),d.e(j.t3);case 21:return j.prev=21,d.f(),j.finish(21);case 24:j.next=48;break;case 26:if(c.type!==_expression.ExprType.Object){j.next=47;break}b={},g=_createForOfIteratorHelper(c.childNodeList),j.prev=29,g.s();case 31:if((h=g.n()).done){j.next=37;break}return i=h.value,j.delegateYield(this.handleValue(i.childNodeList[0].value),"t4",34);case 34:b[i.propName]=j.t4;case 35:j.next=31;break;case 37:j.next=42;break;case 39:j.prev=39,j.t5=j["catch"](29),g.e(j.t5);case 42:return j.prev=42,g.f(),j.finish(42);case 45:j.next=48;break;case 47:throw new Error("[parse AST error] unexpected second node type");case 48:return j.abrupt("return",b);case 49:case"end":return j.stop();}},handleJson,this,[[6,18,21,24],[29,39,42,45]])})},{key:"handleValue",value:_regenerator.default.mark(function handleValue(a){var b,c;return _regenerator.default.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(!(0,_yielder.yielder)()){d.next=3;break}return void(d.next=3);case 3:d.t0=a.type,d.next=d.t0===_token.TokenType.Null?6:d.t0===_token.TokenType.Boolean?7:d.t0===_token.TokenType.Number?9:d.t0===_token.TokenType.String?11:d.t0===_expression.ExprType.Json?12:14;break;case 6:return d.abrupt("return",null);case 7:return b=a.tokens[0].text,d.abrupt("return","true"===b);case 9:return c=+a.tokens[0].text,d.abrupt("return",c);case 11:return d.abrupt("return",a.tokens[0].text.slice(1,-1));case 12:return d.delegateYield(this.handleJson(a),"t1",13);case 13:return d.abrupt("return",d.t1);case 14:throw new Error("[parse AST error] unexpected node type, expect a valid Value node");case 15:case"end":return d.stop();}},handleValue,this)})}]),a}();exports.ASTParser=ASTParser;function parse(a){var b,c,d,e,f;return _regenerator.default.wrap(function(g){for(;;)switch(g.prev=g.next){case 0:return b=new _tokenizer.Tokenizer,g.delegateYield(b.tokenize(a),"t0",2);case 2:return c=g.t0,d=new _ast.AST(c),g.delegateYield(d.buildTree(),"t1",5);case 5:return e=g.t1,f=new ASTParser(e),g.delegateYield(f.getJson(),"t2",8);case 8:return g.abrupt("return",g.t2);case 9:case"end":return g.stop();}},_marked)}